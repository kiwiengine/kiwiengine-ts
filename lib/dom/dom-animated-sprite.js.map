{"version":3,"file":"dom-animated-sprite.js","sourceRoot":"","sources":["../../src/dom/dom-animated-sprite.ts"],"names":[],"mappings":"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","sourcesContent":["import { EventMap } from '@webtaku/event-emitter';\nimport { SpritesheetData } from 'pixi.js';\nimport { DomGameObject, DomGameObjectOptions } from './dom-game-object';\nimport { domTextureLoader } from './loaders/dom-texture';\n\ntype DomAnimatedSpriteOptions = {\n  src?: string;\n  atlas?: SpritesheetData;\n  animation?: string;\n  fps?: number;\n  loop?: boolean;\n} & DomGameObjectOptions;\n\nexport class DomAnimatedSpriteObject<E extends EventMap = EventMap> extends DomGameObject<E & {\n  animationend: (animation: string) => void;\n}> {\n  #frames: string[] = [];\n  #frameDuration?: number;\n  #textureScale = 1;\n  #elapsedTime = 0;\n  #currentFrameIndex = 0;\n\n  #src?: string;\n  #atlas?: SpritesheetData;\n  #animation?: string;\n  #fps?: number;\n  #loop = true;\n\n  constructor(opts?: DomAnimatedSpriteOptions) {\n    super(opts);\n    if (opts) {\n      if (opts.src) this.src = opts.src;\n      if (opts.atlas) this.atlas = opts.atlas;\n      if (opts.animation) this.animation = opts.animation;\n      if (opts.fps) this.fps = opts.fps;\n      if (opts.loop) this.loop = opts.loop;\n    }\n  }\n\n  protected _afterRender(dt: number): void {\n    if (this.#frameDuration === undefined || !this.#atlas || this.#frames.length === 0) return;\n\n    const lastIndex = this.#frames.length - 1;\n\n    if (!this.#loop && this.#currentFrameIndex === lastIndex) return;\n\n    this.#elapsedTime += dt;\n    if (this.#elapsedTime < this.#frameDuration) return;\n    while (this.#elapsedTime >= this.#frameDuration) {\n      this.#elapsedTime -= this.#frameDuration;\n\n      if (this.#currentFrameIndex === lastIndex) {\n        (this as any).emit('animationend', this.#animation ?? '');\n\n        if (this.#loop) {\n          this.#currentFrameIndex = 0;\n        } else {\n          this.#elapsedTime = 0;\n          break;\n        }\n      } else {\n        this.#currentFrameIndex++;\n      }\n    }\n\n    const frameName = this.#frames[this.#currentFrameIndex];\n    const frameData = this.#atlas.frames[frameName].frame;\n\n    this._container.style.width = `${frameData.w * this.#textureScale}px`;\n    this._container.style.height = `${frameData.h * this.#textureScale}px`;\n    this._container.style.backgroundPosition = `-${frameData.x * this.#textureScale}px -${frameData.y * this.#textureScale}px`;\n  }\n\n  async #load() {\n    if (this.#src) {\n      if (!domTextureLoader.checkLoaded(this.#src)) {\n        console.info(`Dom texture not preloaded. Loading now: ${this.#src}`);\n      }\n\n      const texture = await domTextureLoader.load(this.#src);\n      if (!texture) return;\n\n      if (this.#atlas) {\n        this.#frames = this.#animation ? (this.#atlas.animations?.[this.#animation] ?? []) : [];\n\n        const frameName = this.#frames[this.#currentFrameIndex];\n        if (!frameName) return;\n\n        const frameData = this.#atlas.frames[frameName].frame;\n\n        this.#textureScale = this.#atlas.meta.scale === 'auto' ? 1 : Number(this.#atlas.meta.scale);\n\n        this._container.style.backgroundImage = `url(${this.#src})`;\n        this._container.style.width = `${frameData.w * this.#textureScale}px`;\n        this._container.style.height = `${frameData.h * this.#textureScale}px`;\n        this._container.style.backgroundSize = `${texture.width * this.#textureScale}px ${texture.height * this.#textureScale}px`;\n        this._container.style.backgroundPosition = `-${frameData.x * this.#textureScale}px -${frameData.y * this.#textureScale}px`;\n      }\n    }\n  }\n\n  get src() { return this.#src; }\n  set src(src: string | undefined) {\n    if (this.#src !== src) {\n      if (this.#src) domTextureLoader.release(this.#src);\n      this.#src = src;\n      this.#load();\n    }\n  }\n\n  get atlas() { return this.#atlas; }\n  set atlas(atlas: SpritesheetData | undefined) {\n    if (this.#atlas !== atlas) {\n      this.#atlas = atlas;\n      this.#load();\n    }\n  }\n\n  get animation() { return this.#animation; }\n  set animation(animation: string | undefined) {\n    this.#animation = animation;\n    this.#frames = animation ? (this.#atlas?.animations?.[animation] ?? []) : [];\n    this.#currentFrameIndex = 0;\n    this.#elapsedTime = 0;\n  }\n\n  get fps() { return this.#fps; }\n  set fps(fps: number | undefined) {\n    this.#fps = fps;\n    if (fps !== undefined) {\n      this.#frameDuration = 1 / fps;\n    } else {\n      this.#frameDuration = undefined;\n    }\n  }\n\n  get loop() { return this.#loop; }\n  set loop(loop: boolean) { this.#loop = loop; }\n}\n"]}