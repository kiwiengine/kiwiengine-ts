{"version":3,"file":"ticker.js","sourceRoot":"","sources":["../../src/renderer/ticker.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,SAAS,EAAE,MAAM,UAAU,CAAA;AAEpC,MAAM,OAAO,MAAM;IACjB,OAAO,CAAS;IAChB,QAAQ,GAAG,CAAC,CAAA;IAEZ,YAAY,MAA4B;QACtC,IAAI,QAAQ,GAAG,CAAC,CAAA;QAChB,IAAI,UAAU,GAAG,CAAC,CAAA;QAElB,MAAM,IAAI,GAAG,CAAC,SAAiB,EAAE,EAAE;YACjC,MAAM,EAAE,GAAG,CAAC,SAAS,GAAG,QAAQ,CAAC,GAAG,IAAI,CAAA;YACxC,IAAI,EAAE,GAAG,CAAC,EAAE,CAAC;gBACX,MAAM,MAAM,GAAG,IAAI,CAAC,OAAO,CAAA;gBAC3B,IAAI,MAAM,KAAK,SAAS,IAAI,MAAM,GAAG,CAAC,EAAE,CAAC;oBACvC,UAAU,IAAI,EAAE,CAAA;oBAChB,MAAM,SAAS,GAAG,CAAC,GAAG,MAAM,CAAA;oBAC5B,IAAI,UAAU,IAAI,SAAS,EAAE,CAAC;wBAC5B,MAAM,CAAC,SAAS,CAAC,CAAA;wBACjB,IAAI,UAAU,IAAI,SAAS,GAAG,CAAC,EAAE,CAAC;4BAAC,MAAM,CAAC,EAAE,CAAC,CAAC;4BAAC,UAAU,GAAG,CAAC,CAAA;wBAAC,CAAC;6BAC1D,CAAC;4BAAC,UAAU,IAAI,SAAS,CAAA;wBAAC,CAAC;oBAClC,CAAC;gBACH,CAAC;qBAAM,CAAC;oBACN,MAAM,CAAC,EAAE,CAAC,CAAA;gBACZ,CAAC;gBACD,QAAQ,GAAG,SAAS,CAAA;YACtB,CAAC;YACD,IAAI,CAAC,QAAQ,GAAG,qBAAqB,CAAC,IAAI,CAAC,CAAA;QAC7C,CAAC,CAAA;QACD,IAAI,CAAC,QAAQ,GAAG,qBAAqB,CAAC,IAAI,CAAC,CAAA;QAE3C,IAAI,SAAS,EAAE,CAAC;YACd,IAAI,CAAC,QAAQ,CAAC,QAAQ,EAAE;gBAAE,IAAI,CAAC,OAAO,GAAG,CAAC,CAAA;YAC1C,MAAM,CAAC,gBAAgB,CAAC,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,CAAA;YACnD,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,IAAI,CAAC,cAAc,CAAC,CAAA;YACrD,MAAM,CAAC,gBAAgB,CAAC,UAAU,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAA;QAC7D,CAAC;IACH,CAAC;IAED,aAAa,GAAG,GAAG,EAAE,GAAG,IAAI,CAAC,OAAO,GAAG,CAAC,CAAA,CAAC,CAAC,CAAA;IAC1C,cAAc,GAAG,GAAG,EAAE,GAAG,IAAI,CAAC,OAAO,GAAG,SAAS,CAAA,CAAC,CAAC,CAAA;IACnD,iBAAiB,GAAG,CAAC,KAA0B,EAAE,EAAE;QACjD,IAAI,KAAK,CAAC,SAAS,EAAE,CAAC;YACpB,IAAI,CAAC,OAAO,GAAG,SAAS,CAAA;QAC1B,CAAC;IACH,CAAC,CAAA;IAED,MAAM;QACJ,oBAAoB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAA;QACnC,MAAM,CAAC,mBAAmB,CAAC,MAAM,EAAE,IAAI,CAAC,aAAa,CAAC,CAAA;QACtD,MAAM,CAAC,mBAAmB,CAAC,OAAO,EAAE,IAAI,CAAC,cAAc,CAAC,CAAA;QACxD,MAAM,CAAC,mBAAmB,CAAC,UAAU,EAAE,IAAI,CAAC,iBAAiB,CAAC,CAAA;IAChE,CAAC;CACF","sourcesContent":["import { debugMode } from '../debug'\n\nexport class Ticker {\n  #fpsCap?: number\n  #frameId = 0\n\n  constructor(onTick: (dt: number) => void) {\n    let prevTime = 0\n    let lagSeconds = 0\n\n    const step = (timestamp: number) => {\n      const dt = (timestamp - prevTime) / 1000\n      if (dt > 0) {\n        const fpsCap = this.#fpsCap\n        if (fpsCap !== undefined && fpsCap > 0) {\n          lagSeconds += dt\n          const fixedStep = 1 / fpsCap\n          if (lagSeconds >= fixedStep) {\n            onTick(fixedStep)\n            if (lagSeconds >= fixedStep * 2) { onTick(dt); lagSeconds = 0 }\n            else { lagSeconds -= fixedStep }\n          }\n        } else {\n          onTick(dt)\n        }\n        prevTime = timestamp\n      }\n      this.#frameId = requestAnimationFrame(step)\n    }\n    this.#frameId = requestAnimationFrame(step)\n\n    if (debugMode) {\n      if (!document.hasFocus()) this.#fpsCap = 6\n      window.addEventListener('blur', this.#blurListener)\n      window.addEventListener('focus', this.#focusListener)\n      window.addEventListener('pageshow', this.#pageshowListener)\n    }\n  }\n\n  #blurListener = () => { this.#fpsCap = 6 }\n  #focusListener = () => { this.#fpsCap = undefined }\n  #pageshowListener = (event: PageTransitionEvent) => {\n    if (event.persisted) {\n      this.#fpsCap = undefined\n    }\n  }\n\n  remove() {\n    cancelAnimationFrame(this.#frameId)\n    window.removeEventListener('blur', this.#blurListener)\n    window.removeEventListener('focus', this.#focusListener)\n    window.removeEventListener('pageshow', this.#pageshowListener)\n  }\n}\n"]}