{"version":3,"file":"renderer.js","sourceRoot":"","sources":["../../src/renderer/renderer.ts"],"names":[],"mappings":"AACA,OAAO,EAAqB,kBAAkB,EAAe,SAAS,IAAI,aAAa,EAA4B,MAAM,SAAS,CAAA;AAClI,OAAO,EAAE,SAAS,EAAE,MAAM,UAAU,CAAA;AACpC,OAAO,EAAE,QAAQ,EAAE,MAAM,kBAAkB,CAAA;AAC3C,OAAO,EAAE,cAAc,EAAE,MAAM,yBAAyB,CAAA;AACxD,OAAO,EAAE,MAAM,EAAE,MAAM,UAAU,CAAA;AACjC,OAAO,EAAE,wBAAwB,EAAE,MAAM,qBAAqB,CAAA;AAC9D,OAAO,EAAE,UAAU,EAAE,MAAM,eAAe,CAAA;AAC1C,OAAO,EAAE,KAAK,EAAE,MAAM,SAAS,CAAA;AAC/B,OAAO,EAAE,MAAM,EAAE,MAAM,UAAU,CAAA;AAUjC,MAAM,OAAO,QAAS,SAAQ,cAE5B;IAuBmB;IAtBnB,iBAAiB,CAA0B;IAC3C,OAAO,GAAG,IAAI,MAAM,CAAC,CAAC,EAAE,EAAE,EAAE,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,CAAA;IAC9C,MAAM,GAAG,IAAI,MAAM,EAAE,CAAA;IACrB,UAAU,CAAa;IAEvB,aAAa,CAAS;IACtB,cAAc,CAAS;IACvB,gBAAgB,CAAc;IAC9B,gBAAgB,CAAS;IAEzB,aAAa,CAAe;IAC5B,OAAO,GAA8B,EAAE,CAAA;IACvC,YAAY,GAAG,KAAK,CAAA;IAEpB,WAAW,GAAG,CAAC,CAAA;IACf,YAAY,GAAG,CAAC,CAAA;IAChB,UAAU,GAAG,CAAC,CAAA;IACd,SAAS,GAAG,CAAC,CAAA;IACb,aAAa,GAAG,CAAC,CAAA;IACjB,OAAO,GAAG,CAAC,CAAA;IACX,OAAO,GAAG,CAAC,CAAA;IAEX,YAAmB,SAAsB,EAAE,OAAyB;QAClE,KAAK,CAAC,IAAI,aAAa,CAAC,EAAE,gBAAgB,EAAE,IAAI,EAAE,CAAC,CAAC,CAAA;QADnC,cAAS,GAAT,SAAS,CAAa;QAEvC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAA;QAEpB,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAA;QAC3B,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAA;QAC3B,IAAI,CAAC,cAAc,CAAC,UAAU,EAAE,CAAA;QAEhC,IAAI,CAAC,iBAAiB,GAAG,IAAI,wBAAwB,CAAC,SAAS,CAAC,CAAA;QAChE,IAAI,CAAC,iBAAiB,CAAC,EAAE,CAAC,QAAQ,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,EAAE,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC,CAAA;QAEvF,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,iBAAiB,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC,CAAA;QAC/D,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,cAAc,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC,CAAA;QAE5D,IAAI,OAAO,EAAE,CAAC;YACZ,IAAI,OAAO,CAAC,YAAY,KAAK,SAAS;gBAAE,IAAI,CAAC,aAAa,GAAG,OAAO,CAAC,YAAY,CAAA;YACjF,IAAI,OAAO,CAAC,aAAa,KAAK,SAAS;gBAAE,IAAI,CAAC,cAAc,GAAG,OAAO,CAAC,aAAa,CAAA;YACpF,IAAI,OAAO,CAAC,eAAe,KAAK,SAAS;gBAAE,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC,eAAe,CAAA;YAC1F,IAAI,OAAO,CAAC,eAAe,KAAK,SAAS;gBAAE,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC,eAAe,CAAA;YAE1F,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;gBACnB,KAAK,MAAM,WAAW,IAAI,OAAO,CAAC,MAAM,EAAE,CAAC;oBACzC,MAAM,KAAK,GAAG,IAAI,KAAK,CAAC,WAAW,CAAC,SAAS,CAAC,CAAA;oBAC9C,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,KAAK,CAAC,cAAc,CAAC,CAAA;oBAClD,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,IAAI,CAAC,GAAG,KAAK,CAAA;gBACxC,CAAC;YACH,CAAC;QACH,CAAC;QAED,IAAI,SAAS,EAAE,CAAC;YACd,IAAI,CAAC,UAAU,GAAG,IAAI,UAAU,CAAC,SAAS,CAAC,CAAA;QAC7C,CAAC;QAED,IAAI,CAAC,IAAI,EAAE,CAAA;IACb,CAAC;IAEO,KAAK,CAAC,IAAI;QAChB,MAAM,OAAO,GAA+B;YAC1C,SAAS,EAAE,MAAM;YACjB,UAAU,EAAE,MAAM,CAAC,gBAAgB;SACpC,CAAA;QAED,IAAI,IAAI,CAAC,aAAa;YAAE,OAAO,CAAC,KAAK,GAAG,IAAI,CAAC,aAAa,CAAA;QAC1D,IAAI,IAAI,CAAC,cAAc;YAAE,OAAO,CAAC,MAAM,GAAG,IAAI,CAAC,cAAc,CAAA;QAC7D,IAAI,IAAI,CAAC,gBAAgB;YAAE,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,gBAAgB,CAAA;QAC1E,IAAI,IAAI,CAAC,gBAAgB;YAAE,OAAO,CAAC,eAAe,GAAG,IAAI,CAAC,gBAAgB,CAAA;QAE1E,MAAM,EAAE,GAAG,MAAM,kBAAkB,CAAC,OAAO,CAAC,CAAA;QAE5C,QAAQ,CAAC,EAAE,CAAC,MAAM,EAAE;YAClB,QAAQ,EAAE,UAAU;YACpB,WAAW,EAAE,MAAM;SACpB,CAAC,CAAA;QACF,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,EAAE,CAAC,MAAM,CAAC,CAAA;QAErC,IAAI,CAAC,aAAa,GAAG,EAAE,CAAA;QAEvB,MAAM,EAAE,GAAG,IAAI,CAAC,SAAS,CAAC,qBAAqB,EAAE,CAAA;QACjD,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC,MAAM,CAAC,CAAA;IACvC,CAAC;IAED,eAAe;QACb,MAAM,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAA;QAC3B,IAAI,CAAC,cAAc,CAAC,KAAK,GAAG,CAAC,CAAA;QAC7B,IAAI,CAAC,cAAc,CAAC,QAAQ,CAAC,GAAG,CAC9B,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,EAChC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,CACjC,CAAA;IACH,CAAC;IAED,WAAW,CAAC,cAAsB,EAAE,eAAuB;QACzD,MAAM,WAAW,GAAG,IAAI,CAAC,aAAa,IAAI,cAAc,CAAA;QACxD,MAAM,YAAY,GAAG,IAAI,CAAC,cAAc,IAAI,eAAe,CAAA;QAC3D,IAAI,CAAC,WAAW,GAAG,WAAW,CAAA;QAC9B,IAAI,CAAC,YAAY,GAAG,YAAY,CAAA;QAEhC,IAAI,CAAC,OAAO,GAAG,WAAW,GAAG,CAAC,CAAA;QAC9B,IAAI,CAAC,OAAO,GAAG,YAAY,GAAG,CAAC,CAAA;QAC/B,IAAI,CAAC,eAAe,EAAE,CAAA;QAEtB,MAAM,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,GAAG,WAAW,EAAE,eAAe,GAAG,YAAY,CAAC,CAAA;QAChF,IAAI,CAAC,aAAa,GAAG,CAAC,CAAA;QAEtB,MAAM,YAAY,GAAG,WAAW,GAAG,CAAC,CAAA;QACpC,MAAM,aAAa,GAAG,YAAY,GAAG,CAAC,CAAA;QAEtC,MAAM,UAAU,GAAG,CAAC,cAAc,GAAG,YAAY,CAAC,GAAG,CAAC,CAAA;QACtD,MAAM,SAAS,GAAG,CAAC,eAAe,GAAG,aAAa,CAAC,GAAG,CAAC,CAAA;QACvD,IAAI,CAAC,UAAU,GAAG,UAAU,CAAA;QAC5B,IAAI,CAAC,SAAS,GAAG,SAAS,CAAA;QAE1B,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YACvB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,WAAW,EAAE,YAAY,CAAC,CAAA;YAEpD,QAAQ,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE;gBAClC,KAAK,EAAE,GAAG,YAAY,IAAI;gBAC1B,MAAM,EAAE,GAAG,aAAa,IAAI;gBAC5B,IAAI,EAAE,GAAG,UAAU,IAAI;gBACvB,GAAG,EAAE,GAAG,SAAS,IAAI;aACtB,CAAC,CAAA;YAEF,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,WAAW,EAAE,YAAY,CAAC,CAAA;QAChD,CAAC;QAED,IAAI,CAAC,YAAY,GAAG,IAAI,CAAA;IAC1B,CAAC;IAED,OAAO,CAAC,EAAU;QAChB,IAAI,CAAC,YAAY,GAAG,KAAK,CAAA;QAEzB,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAA;QACf,IAAI,CAAC,qBAAqB,EAAE,CAAA;QAC5B,IAAI,CAAC,aAAa,EAAE,MAAM,CAAC,IAAI,CAAC,cAAc,CAAC,CAAA;QAC/C,IAAI,CAAC,UAAU,EAAE,MAAM,EAAE,CAAA;IAC3B,CAAC;IAED,WAAW,CAAC,IAA6C,EAAE,SAAiB;QAC1E,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,CAAA;QACrC,IAAI,CAAC,KAAK;YAAE,MAAM,IAAI,KAAK,CAAC,SAAS,SAAS,kBAAkB,CAAC,CAAA;QACjE,KAAK,CAAC,cAAc,CAAC,QAAQ,CAAC,IAAI,CAAC,cAAc,CAAC,CAAA;IACpD,CAAC;IAEQ,MAAM;QACb,IAAI,CAAC,iBAAiB,CAAC,MAAM,EAAE,CAAA;QAC/B,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAA;QACrB,IAAI,CAAC,aAAa,EAAE,OAAO,EAAE,CAAA;QAC7B,IAAI,CAAC,UAAU,EAAE,MAAM,EAAE,CAAA;QACzB,KAAK,CAAC,MAAM,EAAE,CAAA;IAChB,CAAC;IAED,aAAa,CAAC,OAAe,EAAE,OAAe;QAC5C,MAAM,CAAC,GAAG,CAAC,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,WAAW,GAAG,CAAC,CAAA;QACjF,MAAM,CAAC,GAAG,CAAC,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,CAAA;QACjF,OAAO,EAAE,CAAC,EAAE,CAAC,EAAE,CAAA;IACjB,CAAC;CACF","sourcesContent":["import { EventMap } from '@webtaku/event-emitter'\nimport { AutoDetectOptions, autoDetectRenderer, ColorSource, Container as PixiContainer, Renderer as PixiRenderer } from 'pixi.js'\nimport { debugMode } from '../debug'\nimport { setStyle } from '../dom/dom-utils'\nimport { RenderableNode } from '../node/core/renderable'\nimport { Camera } from './camera'\nimport { RendererContainerManager } from './container-manager'\nimport { FpsDisplay } from './fps-display'\nimport { Layer } from './layer'\nimport { Ticker } from './ticker'\n\nexport type RendererOptions = {\n  logicalWidth?: number\n  logicalHeight?: number\n  backgroundColor?: ColorSource\n  backgroundAlpha?: number\n  layers?: { name: string; drawOrder: number }[]\n}\n\nexport class Renderer extends RenderableNode<PixiContainer, {\n  resize: (width: number, height: number) => void\n}> {\n  #containerManager: RendererContainerManager\n  #ticker = new Ticker((dt) => this.#render(dt))\n  camera = new Camera()\n  fpsDisplay?: FpsDisplay\n\n  #logicalWidth?: number\n  #logicalHeight?: number\n  #backgroundColor?: ColorSource\n  #backgroundAlpha?: number\n\n  #pixiRenderer?: PixiRenderer\n  #layers: { [name: string]: Layer } = {}\n  _isSizeDirty = false\n\n  canvasWidth = 0\n  canvasHeight = 0\n  canvasLeft = 0\n  canvasTop = 0\n  viewportScale = 1\n  centerX = 0\n  centerY = 0\n\n  constructor(public container: HTMLElement, options?: RendererOptions) {\n    super(new PixiContainer({ sortableChildren: true }))\n    this.renderer = this\n\n    this.worldTransform.x.v = 0\n    this.worldTransform.y.v = 0\n    this.worldTransform.resetDirty()\n\n    this.#containerManager = new RendererContainerManager(container)\n    this.#containerManager.on('resize', (width, height) => this.#updateSize(width, height))\n\n    this.camera.on('positionChanged', () => this.#updatePosition())\n    this.camera.on('scaleChanged', () => this.#updatePosition())\n\n    if (options) {\n      if (options.logicalWidth !== undefined) this.#logicalWidth = options.logicalWidth\n      if (options.logicalHeight !== undefined) this.#logicalHeight = options.logicalHeight\n      if (options.backgroundColor !== undefined) this.#backgroundColor = options.backgroundColor\n      if (options.backgroundAlpha !== undefined) this.#backgroundAlpha = options.backgroundAlpha\n\n      if (options.layers) {\n        for (const layerOption of options.layers) {\n          const layer = new Layer(layerOption.drawOrder)\n          this._pixiContainer.addChild(layer._pixiContainer)\n          this.#layers[layerOption.name] = layer\n        }\n      }\n    }\n\n    if (debugMode) {\n      this.fpsDisplay = new FpsDisplay(container)\n    }\n\n    this.init()\n  }\n\n  private async init() {\n    const options: Partial<AutoDetectOptions> = {\n      eventMode: 'none',\n      resolution: window.devicePixelRatio,\n    }\n\n    if (this.#logicalWidth) options.width = this.#logicalWidth\n    if (this.#logicalHeight) options.height = this.#logicalHeight\n    if (this.#backgroundColor) options.backgroundColor = this.#backgroundColor\n    if (this.#backgroundAlpha) options.backgroundAlpha = this.#backgroundAlpha\n\n    const pr = await autoDetectRenderer(options)\n\n    setStyle(pr.canvas, {\n      position: 'absolute',\n      touchAction: 'auto',\n    })\n    this.container.appendChild(pr.canvas)\n\n    this.#pixiRenderer = pr\n\n    const cr = this.container.getBoundingClientRect()\n    this.#updateSize(cr.width, cr.height)\n  }\n\n  #updatePosition() {\n    const S = this.camera.scale\n    this._pixiContainer.scale = S\n    this._pixiContainer.position.set(\n      this.centerX - this.camera.x * S,\n      this.centerY - this.camera.y * S\n    )\n  }\n\n  #updateSize(containerWidth: number, containerHeight: number) {\n    const canvasWidth = this.#logicalWidth ?? containerWidth\n    const canvasHeight = this.#logicalHeight ?? containerHeight\n    this.canvasWidth = canvasWidth\n    this.canvasHeight = canvasHeight\n\n    this.centerX = canvasWidth / 2\n    this.centerY = canvasHeight / 2\n    this.#updatePosition()\n\n    const S = Math.min(containerWidth / canvasWidth, containerHeight / canvasHeight)\n    this.viewportScale = S\n\n    const displayWidth = canvasWidth * S\n    const displayHeight = canvasHeight * S\n\n    const canvasLeft = (containerWidth - displayWidth) / 2\n    const canvasTop = (containerHeight - displayHeight) / 2\n    this.canvasLeft = canvasLeft\n    this.canvasTop = canvasTop\n\n    if (this.#pixiRenderer) {\n      this.#pixiRenderer.resize(canvasWidth, canvasHeight)\n\n      setStyle(this.#pixiRenderer.canvas, {\n        width: `${displayWidth}px`,\n        height: `${displayHeight}px`,\n        left: `${canvasLeft}px`,\n        top: `${canvasTop}px`,\n      })\n\n      this.emit('resize', canvasWidth, canvasHeight)\n    }\n\n    this._isSizeDirty = true\n  }\n\n  #render(dt: number) {\n    this._isSizeDirty = false\n\n    this.update(dt)\n    this._updateWorldTransform()\n    this.#pixiRenderer?.render(this._pixiContainer)\n    this.fpsDisplay?.update()\n  }\n\n  _addToLayer(node: RenderableNode<PixiContainer, EventMap>, layerName: string) {\n    const layer = this.#layers[layerName]\n    if (!layer) throw new Error(`Layer ${layerName} does not exist.`)\n    layer._pixiContainer.addChild(node._pixiContainer)\n  }\n\n  override remove() {\n    this.#containerManager.remove()\n    this.#ticker.remove()\n    this.#pixiRenderer?.destroy()\n    this.fpsDisplay?.remove()\n    super.remove()\n  }\n\n  screenToWorld(screenX: number, screenY: number) {\n    const x = (screenX - this.canvasLeft) / this.viewportScale - this.canvasWidth / 2\n    const y = (screenY - this.canvasTop) / this.viewportScale - this.canvasHeight / 2\n    return { x, y }\n  }\n}\n"]}