{"version":3,"file":"joystick.js","sourceRoot":"","sources":["../../src/input/joystick.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,0BAA0B,CAAA;AAGrD,MAAM,WAAW,GAAG,IAAI,GAAG,CAAC,CAAC,SAAS,EAAE,WAAW,EAAE,WAAW,EAAE,YAAY,CAAC,CAAC,CAAA;AAEhF,SAAS,OAAO,CAAC,IAAY;IAC3B,OAAO,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;AAC9B,CAAC;AAED,SAAS,WAAW,CAAC,EAAU,EAAE,EAAU,EAAE,IAAY;IACvD,MAAM,IAAI,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE,EAAE,CAAC,CAAA;IAC/B,IAAI,IAAI,IAAI,IAAI,IAAI,IAAI,KAAK,CAAC;QAAE,OAAO,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,CAAA;IAC7D,MAAM,CAAC,GAAG,IAAI,GAAG,IAAI,CAAA;IACrB,OAAO,EAAE,CAAC,EAAE,EAAE,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,GAAG,CAAC,EAAE,IAAI,EAAE,IAAI,EAAE,CAAA;AAC7C,CAAC;AAED,SAAS,QAAQ,CAAC,EAA2B,EAAE,MAAoC;IACjF,IAAI,CAAC,EAAE;QAAE,OAAM;IACf,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,EAAE,MAAM,CAAC,CAAA;IAC/B,OAAO,EAAE,CAAA;AACX,CAAC;AAED,SAAS,WAAW,CAAC,EAA2B,EAAE,IAAY,EAAE,GAAW;IACzE,IAAI,CAAC,EAAE;QAAE,OAAM;IACf,EAAE,CAAC,KAAK,CAAC,IAAI,GAAG,GAAG,IAAI,IAAI,CAAA;IAC3B,EAAE,CAAC,KAAK,CAAC,GAAG,GAAG,GAAG,GAAG,IAAI,CAAA;AAC3B,CAAC;AAkBD,MAAM,OAAO,QAAS,SAAQ,UAAU;IACtC,SAAS;IACT,aAAa,GAAG,IAAI,GAAG,EAAU,CAAA;IACjC,kBAAkB,GAAG,IAAI,GAAG,EAAU,CAAA;IAEtC,QAAQ;IACR,cAAc,CAAS;IACvB,YAAY,GAAG,CAAC,CAAA;IAChB,YAAY,GAAG,CAAC,CAAA;IAChB,OAAO,GAAG,KAAK,CAAA;IAEf,YAAY;IACZ,cAAc,CAAc;IAC5B,UAAU,CAAc;IACxB,gBAAgB,CAAQ;IACxB,cAAc,CAAQ;IACtB,aAAa,CAA+B;IAE5C,KAAK;IACL,OAAO,CAA4C;IACnD,UAAU,CAAY;IACtB,UAAU,CAAyB;IAEnC,YAAY,OAAwB;QAClC,KAAK,EAAE,CAAA;QAEP,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,MAAM,CAAA;QAC7B,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,SAAS,CAAA;QACnC,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,SAAS,CAAA;QACnC,IAAI,CAAC,cAAc,GAAG,OAAO,CAAC,aAAa,CAAA;QAC3C,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,SAAS,CAAA;QACnC,IAAI,CAAC,gBAAgB,GAAG,OAAO,CAAC,eAAe,IAAI,EAAE,CAAA;QACrD,IAAI,CAAC,cAAc,GAAG,OAAO,CAAC,aAAa,IAAI,CAAC,CAAA;QAChD,IAAI,CAAC,aAAa,GAAG,OAAO,CAAC,YAAY,IAAI,EAAE,IAAI,EAAE,CAAC,MAAM,EAAE,GAAG,EAAE,CAAC,MAAM,EAAE,CAAA;QAE5E,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,CAAA;QACnD,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAA;QAC/C,MAAM,CAAC,gBAAgB,CAAC,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,CAAA;IAC/C,CAAC;IAED,IAAuB,QAAQ,CAAC,QAA8B;QAC5D,MAAM,IAAI,GAAG,KAAK,CAAC,QAAQ,CAAA;QAC3B,IAAI,IAAI,EAAE,CAAC;YACT,MAAM,EAAE,GAAG,IAAI,CAAC,SAAS,CAAA;YACzB,EAAE,CAAC,mBAAmB,CAAC,YAAY,EAAE,IAAI,CAAC,aAAa,CAAC,CAAA;YACxD,EAAE,CAAC,mBAAmB,CAAC,WAAW,EAAE,IAAI,CAAC,YAAY,CAAC,CAAA;YACtD,EAAE,CAAC,mBAAmB,CAAC,UAAU,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;YACpD,EAAE,CAAC,mBAAmB,CAAC,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;QACzD,CAAC;QAED,KAAK,CAAC,QAAQ,GAAG,QAAQ,CAAA;QACzB,IAAI,QAAQ,EAAE,CAAC;YACb,MAAM,CAAC,GAAG,QAAQ,CAAC,SAAS,CAAA;YAC5B,CAAC,CAAC,gBAAgB,CAAC,YAAY,EAAE,IAAI,CAAC,aAAa,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAA;YACxE,CAAC,CAAC,gBAAgB,CAAC,WAAW,EAAE,IAAI,CAAC,YAAY,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAA;YACtE,CAAC,CAAC,gBAAgB,CAAC,UAAU,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;YAChD,CAAC,CAAC,gBAAgB,CAAC,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;YAEnD,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;gBACxB,QAAQ,CAAC,IAAI,CAAC,cAAc,EAAE;oBAC5B,QAAQ,EAAE,UAAU;oBACpB,IAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,IAAI;oBACpC,GAAG,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,IAAI;oBAClC,MAAM,EAAE,QAAQ;oBAChB,SAAS,EAAE,uBAAuB;oBAClC,aAAa,EAAE,MAAM;iBACtB,CAAC,CAAA;gBACF,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,cAAc,CAAC,CAAA;YACpC,CAAC;YAED,IAAI,IAAI,CAAC,UAAU,EAAE,CAAC;gBACpB,QAAQ,CAAC,IAAI,CAAC,UAAU,EAAE;oBACxB,QAAQ,EAAE,UAAU;oBACpB,IAAI,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,IAAI,IAAI;oBACpC,GAAG,EAAE,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,IAAI;oBAClC,MAAM,EAAE,QAAQ;oBAChB,SAAS,EAAE,uBAAuB;oBAClC,aAAa,EAAE,MAAM;iBACtB,CAAC,CAAA;gBACF,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,UAAU,CAAC,CAAA;YAChC,CAAC;QACH,CAAC;IACH,CAAC;IAED,IAAuB,QAAQ;QAC7B,OAAO,KAAK,CAAC,QAAQ,CAAA;IACvB,CAAC;IAED,aAAa,GAAG,CAAC,KAAiB,EAAE,EAAE;QACpC,IAAI,IAAI,CAAC,MAAM;YAAE,OAAM;QACvB,KAAK,CAAC,cAAc,EAAE,CAAA;QAEtB,IAAI,IAAI,CAAC,cAAc,KAAK,SAAS;YAAE,OAAM;QAE7C,MAAM,KAAK,GAAG,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC,CAAA;QACrC,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC,UAAU,CAAA;QACtC,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC,OAAO,CAAA;QACjC,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC,OAAO,CAAA;QACjC,IAAI,CAAC,OAAO,GAAG,KAAK,CAAA;QAEpB,IAAI,CAAC,IAAI,CAAC,QAAQ;YAAE,OAAM;QAE1B,MAAM,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,qBAAqB,EAAE,CAAA;QACzD,MAAM,IAAI,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,IAAI,CAAA;QACvC,MAAM,GAAG,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,GAAG,CAAA;QAErC,WAAW,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;QAC3C,WAAW,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;IACzC,CAAC,CAAA;IAED,YAAY,GAAG,CAAC,KAAiB,EAAE,EAAE;QACnC,IAAI,IAAI,CAAC,MAAM;YAAE,OAAM;QACvB,KAAK,CAAC,cAAc,EAAE,CAAA;QAEtB,IAAI,IAAI,CAAC,cAAc,KAAK,SAAS;YAAE,OAAM;QAE7C,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACrD,MAAM,CAAC,GAAG,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC,CAAA;YACjC,IAAI,CAAC,CAAC,UAAU,KAAK,IAAI,CAAC,cAAc;gBAAE,SAAQ;YAElD,MAAM,EAAE,GAAG,CAAC,CAAC,OAAO,GAAG,IAAI,CAAC,YAAY,CAAA;YACxC,MAAM,EAAE,GAAG,CAAC,CAAC,OAAO,GAAG,IAAI,CAAC,YAAY,CAAA;YAExC,MAAM,EAAE,CAAC,EAAE,EAAE,EAAE,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,GAAG,WAAW,CAAC,EAAE,EAAE,EAAE,EAAE,IAAI,CAAC,gBAAgB,CAAC,CAAA;YAEzE,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;gBAClB,MAAM,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,qBAAqB,EAAE,CAAA;gBACzD,MAAM,IAAI,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,IAAI,GAAG,EAAE,CAAA;gBAC5C,MAAM,GAAG,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC,GAAG,GAAG,EAAE,CAAA;gBAC1C,WAAW,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;YACzC,CAAC;YAED,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;gBAChD,IAAI,CAAC,OAAO,GAAG,IAAI,CAAA;gBACnB,IAAI,EAAE,KAAK,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,CAAC;oBACzB,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE,EAAE,CAAC,CAAA;oBACjC,MAAM,UAAU,GAAG,IAAI,CAAC,gBAAgB,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,GAAG,IAAI,CAAC,gBAAgB,CAAA;oBACjF,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,UAAU,CAAC,CAAA;gBAClC,CAAC;YACH,CAAC;YACD,MAAK;QACP,CAAC;IACH,CAAC,CAAA;IAED,WAAW,GAAG,CAAC,KAAiB,EAAE,EAAE;QAClC,IAAI,IAAI,CAAC,MAAM,IAAI,IAAI,CAAC,cAAc,KAAK,SAAS;YAAE,OAAM;QAE5D,IAAI,KAAK,GAAG,KAAK,CAAA;QACjB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACrD,IAAI,KAAK,CAAC,cAAc,CAAC,CAAC,CAAC,CAAC,UAAU,KAAK,IAAI,CAAC,cAAc,EAAE,CAAC;gBAC/D,KAAK,GAAG,IAAI,CAAA;gBACZ,MAAK;YACP,CAAC;QACH,CAAC;QACD,IAAI,CAAC,KAAK;YAAE,OAAM;QAElB,IAAI,CAAC,cAAc,GAAG,SAAS,CAAA;QAE/B,YAAY;QACZ,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,aAAa,CAAA;QACxC,WAAW,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;QAC3C,WAAW,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;QAEvC,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,IAAI,CAAC,OAAO,GAAG,KAAK,CAAA;YACpB,IAAI,CAAC,UAAU,EAAE,CAAA;QACnB,CAAC;IACH,CAAC,CAAA;IAED,kBAAkB;QAChB,IAAI,EAAE,GAAG,CAAC,CAAA;QACV,IAAI,EAAE,GAAG,CAAC,CAAA;QAEV,IAAI,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,SAAS,CAAC;YAAE,EAAE,IAAI,CAAC,CAAA;QACnD,IAAI,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,WAAW,CAAC;YAAE,EAAE,IAAI,CAAC,CAAA;QACrD,IAAI,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,WAAW,CAAC;YAAE,EAAE,IAAI,CAAC,CAAA;QACrD,IAAI,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,YAAY,CAAC;YAAE,EAAE,IAAI,CAAC,CAAA;QAEtD,IAAI,EAAE,KAAK,CAAC,IAAI,EAAE,KAAK,CAAC,EAAE,CAAC;YACzB,MAAM,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,EAAE,EAAE,EAAE,CAAC,CAAA;YACjC,0BAA0B;YAC1B,IAAI,CAAC,OAAO,CAAC,MAAM,EAAE,CAAC,CAAC,CAAA;QACzB,CAAC;IACH,CAAC;IAED,UAAU,GAAG,CAAC,KAAoB,EAAE,EAAE;QACpC,IAAI,IAAI,CAAC,MAAM;YAAE,OAAM;QAEvB,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,CAAA;QACvB,IAAI,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC;YAAE,OAAM;QAExC,IAAI,CAAC,aAAa,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;QAC5B,IAAI,CAAC,UAAU,EAAE,CAAC,IAAI,CAAC,CAAA;QAEvB,IAAI,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;YAClB,MAAM,MAAM,GAAG,KAAK,CAAC,MAA4B,CAAA;YACjD,MAAM,SAAS,GACb,CAAC,CAAC,MAAM,EAAE,OAAO,CAAC,mEAAmE,CAAC,CAAA;YACxF,IAAI,CAAC,SAAS;gBAAE,KAAK,CAAC,cAAc,EAAE,CAAA;YAEtC,IAAI,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;YACjC,IAAI,CAAC,kBAAkB,EAAE,CAAA;QAC3B,CAAC;IACH,CAAC,CAAA;IAED,QAAQ,GAAG,CAAC,KAAoB,EAAE,EAAE;QAClC,IAAI,IAAI,CAAC,MAAM;YAAE,OAAM;QAEvB,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,CAAA;QACvB,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;QAE/B,IAAI,OAAO,CAAC,IAAI,CAAC,EAAE,CAAC;YAClB,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;YAEpC,IAAI,IAAI,CAAC,kBAAkB,CAAC,IAAI,KAAK,CAAC,EAAE,CAAC;gBACvC,IAAI,CAAC,UAAU,EAAE,CAAA;YACnB,CAAC;iBAAM,CAAC;gBACN,IAAI,CAAC,kBAAkB,EAAE,CAAA;YAC3B,CAAC;QACH,CAAC;IACH,CAAC,CAAA;IAED,OAAO,GAAG,GAAG,EAAE;QACb,IAAI,IAAI,CAAC,MAAM;YAAE,OAAM;QAEvB,gBAAgB;QAChB,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE,CAAA;QAC1B,IAAI,CAAC,kBAAkB,CAAC,KAAK,EAAE,CAAA;QAC/B,IAAI,CAAC,cAAc,GAAG,SAAS,CAAA;QAC/B,IAAI,CAAC,OAAO,GAAG,KAAK,CAAA;QAEpB,YAAY;QACZ,MAAM,EAAE,IAAI,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,aAAa,CAAA;QACxC,WAAW,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;QAC3C,WAAW,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,EAAE,GAAG,CAAC,CAAA;QAEvC,IAAI,CAAC,UAAU,EAAE,CAAA;IACnB,CAAC,CAAA;IAEQ,KAAK;QACZ,IAAI,CAAC,OAAO,EAAE,CAAA;QACd,KAAK,CAAC,KAAK,EAAE,CAAA;IACf,CAAC;IAED,4BAA4B;IAC5B,eAAe,CAAC,CAAgC;QAC9C,IAAI,CAAC,aAAa,GAAG,CAAC,CAAA;QAEtB,qBAAqB;QACrB,IAAI,IAAI,CAAC,cAAc,KAAK,SAAS;YAAE,OAAM;QAE7C,WAAW,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC,GAAG,CAAC,CAAA;QAC/C,WAAW,CAAC,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC,GAAG,CAAC,CAAA;IAC7C,CAAC;IAEQ,MAAM;QACb,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAA;QAC9B,IAAI,QAAQ,EAAE,CAAC;YACb,MAAM,CAAC,GAAG,QAAQ,CAAC,SAAS,CAAA;YAC5B,CAAC,CAAC,mBAAmB,CAAC,YAAY,EAAE,IAAI,CAAC,aAAa,CAAC,CAAA;YACvD,CAAC,CAAC,mBAAmB,CAAC,WAAW,EAAE,IAAI,CAAC,YAAY,CAAC,CAAA;YACrD,CAAC,CAAC,mBAAmB,CAAC,UAAU,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;YACnD,CAAC,CAAC,mBAAmB,CAAC,aAAa,EAAE,IAAI,CAAC,WAAW,CAAC,CAAA;QACxD,CAAC;QAED,aAAa;QACb,MAAM,CAAC,mBAAmB,CAAC,SAAS,EAAE,IAAI,CAAC,UAAU,CAAC,CAAA;QACtD,MAAM,CAAC,mBAAmB,CAAC,OAAO,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAA;QAClD,MAAM,CAAC,mBAAmB,CAAC,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,CAAA;QAEhD,YAAY;QACZ,IAAI,CAAC,cAAc,EAAE,MAAM,EAAE,CAAA;QAC7B,IAAI,CAAC,UAAU,EAAE,MAAM,EAAE,CAAA;QAEzB,KAAK,CAAC,MAAM,EAAE,CAAA;IAChB,CAAC;CACF","sourcesContent":["import { GameObject } from '../node/core/game-object'\nimport { Renderer } from '../renderer/renderer'\n\nconst ARROW_CODES = new Set(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'])\n\nfunction isArrow(code: string): boolean {\n  return ARROW_CODES.has(code)\n}\n\nfunction clampVector(dx: number, dy: number, maxR: number) {\n  const dist = Math.hypot(dx, dy)\n  if (dist <= maxR || dist === 0) return { x: dx, y: dy, dist }\n  const s = maxR / dist\n  return { x: dx * s, y: dy * s, dist: maxR }\n}\n\nfunction setStyle(el: HTMLElement | undefined, styles: Partial<CSSStyleDeclaration>) {\n  if (!el) return\n  Object.assign(el.style, styles)\n  return el\n}\n\nfunction setPosition(el: HTMLElement | undefined, left: number, top: number) {\n  if (!el) return\n  el.style.left = `${left}px`\n  el.style.top = `${top}px`\n}\n\nexport type JoystickOptions = {\n  // 공통 필수 콜백\n  onMove: (radian: number, strength: number) => void // 키보드일 때 strength=1\n  onRelease: () => void\n\n  // 선택 콜백\n  onKeyDown?: (code: string) => void\n\n  // (선택) 터치 전용 리소스/옵션\n  joystickImage?: HTMLElement         // 조이스틱 배경\n  knobImage?: HTMLElement             // 노브(스틱)\n  maxKnobDistance?: number            // px (기본 80)\n  moveThreshold?: number              // px (기본 0)\n  idlePosition?: { left: number; top: number } // 이미지 기본 위치 (기본값은 숨김 위치 -999999, -999999)\n}\n\nexport class Joystick extends GameObject {\n  // 키보드 상태\n  #codesPressed = new Set<string>()\n  #arrowCodesPressed = new Set<string>()\n\n  // 터치 상태\n  #activeTouchId?: number\n  #touchStartX = 0\n  #touchStartY = 0\n  #moving = false\n\n  // DOM (터치용)\n  #joystickImage?: HTMLElement\n  #knobImage?: HTMLElement\n  #maxKnobDistance: number\n  #moveThreshold: number\n  #idlePosition: { left: number; top: number }\n\n  // 콜백\n  #onMove: (radian: number, strength: number) => void\n  #onRelease: () => void\n  #onKeydown?: (code: string) => void\n\n  constructor(options: JoystickOptions) {\n    super()\n\n    this.#onMove = options.onMove\n    this.#onRelease = options.onRelease\n    this.#onKeydown = options.onKeyDown\n    this.#joystickImage = options.joystickImage\n    this.#knobImage = options.knobImage\n    this.#maxKnobDistance = options.maxKnobDistance ?? 80\n    this.#moveThreshold = options.moveThreshold ?? 0\n    this.#idlePosition = options.idlePosition ?? { left: -999999, top: -999999 }\n\n    window.addEventListener('keydown', this.#onKeyDown)\n    window.addEventListener('keyup', this.#onKeyUp)\n    window.addEventListener('blur', this.#onBlur)\n  }\n\n  protected override set renderer(renderer: Renderer | undefined) {\n    const prev = super.renderer\n    if (prev) {\n      const pc = prev.container\n      pc.removeEventListener('touchstart', this.#onTouchStart)\n      pc.removeEventListener('touchmove', this.#onTouchMove)\n      pc.removeEventListener('touchend', this.#onTouchEnd)\n      pc.removeEventListener('touchcancel', this.#onTouchEnd)\n    }\n\n    super.renderer = renderer\n    if (renderer) {\n      const c = renderer.container\n      c.addEventListener('touchstart', this.#onTouchStart, { passive: false })\n      c.addEventListener('touchmove', this.#onTouchMove, { passive: false })\n      c.addEventListener('touchend', this.#onTouchEnd)\n      c.addEventListener('touchcancel', this.#onTouchEnd)\n\n      if (this.#joystickImage) {\n        setStyle(this.#joystickImage, {\n          position: 'absolute',\n          left: `${this.#idlePosition.left}px`,\n          top: `${this.#idlePosition.top}px`,\n          zIndex: '999998',\n          transform: 'translate(-50%, -50%)',\n          pointerEvents: 'none',\n        })\n        c.appendChild(this.#joystickImage)\n      }\n\n      if (this.#knobImage) {\n        setStyle(this.#knobImage, {\n          position: 'absolute',\n          left: `${this.#idlePosition.left}px`,\n          top: `${this.#idlePosition.top}px`,\n          zIndex: '999999',\n          transform: 'translate(-50%, -50%)',\n          pointerEvents: 'none',\n        })\n        c.appendChild(this.#knobImage)\n      }\n    }\n  }\n\n  protected override get renderer() {\n    return super.renderer\n  }\n\n  #onTouchStart = (event: TouchEvent) => {\n    if (this.paused) return\n    event.preventDefault()\n\n    if (this.#activeTouchId !== undefined) return\n\n    const touch = event.changedTouches[0]\n    this.#activeTouchId = touch.identifier\n    this.#touchStartX = touch.clientX\n    this.#touchStartY = touch.clientY\n    this.#moving = false\n\n    if (!this.renderer) return\n\n    const r = this.renderer.container.getBoundingClientRect()\n    const left = this.#touchStartX - r.left\n    const top = this.#touchStartY - r.top\n\n    setPosition(this.#joystickImage, left, top)\n    setPosition(this.#knobImage, left, top)\n  }\n\n  #onTouchMove = (event: TouchEvent) => {\n    if (this.paused) return\n    event.preventDefault()\n\n    if (this.#activeTouchId === undefined) return\n\n    for (let i = 0; i < event.changedTouches.length; i++) {\n      const t = event.changedTouches[i]\n      if (t.identifier !== this.#activeTouchId) continue\n\n      const dx = t.clientX - this.#touchStartX\n      const dy = t.clientY - this.#touchStartY\n\n      const { x: cx, y: cy, dist } = clampVector(dx, dy, this.#maxKnobDistance)\n\n      if (this.renderer) {\n        const r = this.renderer.container.getBoundingClientRect()\n        const left = this.#touchStartX - r.left + cx\n        const top = this.#touchStartY - r.top + cy\n        setPosition(this.#knobImage, left, top)\n      }\n\n      if (this.#moving || dist >= this.#moveThreshold) {\n        this.#moving = true\n        if (cx !== 0 || cy !== 0) {\n          const radian = Math.atan2(cy, cx)\n          const normalized = this.#maxKnobDistance === 0 ? 0 : dist / this.#maxKnobDistance\n          this.#onMove(radian, normalized)\n        }\n      }\n      break\n    }\n  }\n\n  #onTouchEnd = (event: TouchEvent) => {\n    if (this.paused || this.#activeTouchId === undefined) return\n\n    let ended = false\n    for (let i = 0; i < event.changedTouches.length; i++) {\n      if (event.changedTouches[i].identifier === this.#activeTouchId) {\n        ended = true\n        break\n      }\n    }\n    if (!ended) return\n\n    this.#activeTouchId = undefined\n\n    // 기본 위치로 복귀\n    const { left, top } = this.#idlePosition\n    setPosition(this.#joystickImage, left, top)\n    setPosition(this.#knobImage, left, top)\n\n    if (this.#moving) {\n      this.#moving = false\n      this.#onRelease()\n    }\n  }\n\n  #emitFromArrowKeys() {\n    let dx = 0\n    let dy = 0\n\n    if (this.#arrowCodesPressed.has('ArrowUp')) dy -= 1\n    if (this.#arrowCodesPressed.has('ArrowDown')) dy += 1\n    if (this.#arrowCodesPressed.has('ArrowLeft')) dx -= 1\n    if (this.#arrowCodesPressed.has('ArrowRight')) dx += 1\n\n    if (dx !== 0 || dy !== 0) {\n      const radian = Math.atan2(dy, dx)\n      // 키보드: strength=1 로 일관 전달\n      this.#onMove(radian, 1)\n    }\n  }\n\n  #onKeyDown = (event: KeyboardEvent) => {\n    if (this.paused) return\n\n    const code = event.code\n    if (this.#codesPressed.has(code)) return\n\n    this.#codesPressed.add(code)\n    this.#onKeydown?.(code)\n\n    if (isArrow(code)) {\n      const target = event.target as HTMLElement | null\n      const isEditing =\n        !!target?.closest('input, textarea, [contenteditable]:not([contenteditable=\"false\"])')\n      if (!isEditing) event.preventDefault()\n\n      this.#arrowCodesPressed.add(code)\n      this.#emitFromArrowKeys()\n    }\n  }\n\n  #onKeyUp = (event: KeyboardEvent) => {\n    if (this.paused) return\n\n    const code = event.code\n    this.#codesPressed.delete(code)\n\n    if (isArrow(code)) {\n      this.#arrowCodesPressed.delete(code)\n\n      if (this.#arrowCodesPressed.size === 0) {\n        this.#onRelease()\n      } else {\n        this.#emitFromArrowKeys()\n      }\n    }\n  }\n\n  #onBlur = () => {\n    if (this.paused) return\n\n    // 키보드/터치 공통 릴리즈\n    this.#codesPressed.clear()\n    this.#arrowCodesPressed.clear()\n    this.#activeTouchId = undefined\n    this.#moving = false\n\n    // 기본 위치로 복귀\n    const { left, top } = this.#idlePosition\n    setPosition(this.#joystickImage, left, top)\n    setPosition(this.#knobImage, left, top)\n\n    this.#onRelease()\n  }\n\n  override pause() {\n    this.#onBlur()\n    super.pause()\n  }\n\n  // 조이스틱 이미지의 기본 위치(숨김 좌표) 설정\n  setIdlePosition(p: { left: number; top: number }): void {\n    this.#idlePosition = p\n\n    // 드래그 중이면 즉시 반영하지 않음\n    if (this.#activeTouchId !== undefined) return\n\n    setPosition(this.#joystickImage, p.left, p.top)\n    setPosition(this.#knobImage, p.left, p.top)\n  }\n\n  override remove() {\n    const renderer = this.renderer\n    if (renderer) {\n      const c = renderer.container\n      c.removeEventListener('touchstart', this.#onTouchStart)\n      c.removeEventListener('touchmove', this.#onTouchMove)\n      c.removeEventListener('touchend', this.#onTouchEnd)\n      c.removeEventListener('touchcancel', this.#onTouchEnd)\n    }\n\n    // 윈도우 리스너 정리\n    window.removeEventListener('keydown', this.#onKeyDown)\n    window.removeEventListener('keyup', this.#onKeyUp)\n    window.removeEventListener('blur', this.#onBlur)\n\n    // DOM 노드 제거\n    this.#joystickImage?.remove()\n    this.#knobImage?.remove()\n\n    super.remove()\n  }\n}\n"]}