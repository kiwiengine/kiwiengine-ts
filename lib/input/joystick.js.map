{"version":3,"file":"joystick.js","sourceRoot":"","sources":["../../src/input/joystick.ts"],"names":[],"mappings":"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","sourcesContent":["import { GameObject } from '../node/core/game-object'\nimport { Renderer } from '../renderer/renderer'\n\nconst ARROW_CODES = new Set(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'])\n\nfunction isArrow(code: string): boolean {\n  return ARROW_CODES.has(code)\n}\n\nfunction clampVector(dx: number, dy: number, maxR: number) {\n  const dist = Math.hypot(dx, dy)\n  if (dist <= maxR || dist === 0) return { x: dx, y: dy, dist }\n  const s = maxR / dist\n  return { x: dx * s, y: dy * s, dist: maxR }\n}\n\nexport type JoystickOptions = {\n  // 공통 필수 콜백\n  onMove: (radian: number, distance: number) => void // 키보드일 때 distance=1\n  onRelease: () => void\n\n  // 선택 콜백\n  onKeydown?: (code: string) => void\n\n  // (선택) 터치 전용 리소스/옵션\n  joystickImage?: HTMLElement         // 조이스틱 배경\n  knobImage?: HTMLElement             // 노브(스틱)\n  maxKnobDistance?: number            // px (기본 80)\n  moveThreshold?: number              // px (기본 0)\n  imageDefaultPosition?: { left: number; top: number } // 이미지 기본 위치 (기본값은 숨김 위치 -999999, -999999)\n}\n\nexport class Joystick extends GameObject {\n  // 키보드 상태\n  #codesPressed = new Set<string>()\n  #arrowCodesPressed = new Set<string>()\n\n  // 터치 상태\n  #activeTouchId?: number\n  #touchStartX = 0\n  #touchStartY = 0\n  #isMoving = false\n\n  // DOM (터치용)\n  #joystickImage?: HTMLElement\n  #knobImage?: HTMLElement\n  #maxKnobDistance: number\n  #moveThreshold: number\n  #imageDefaultPosition: { left: number; top: number }\n\n  // 콜백\n  #onMove: (radian: number, distance: number) => void\n  #onRelease: () => void\n  #onKeydown?: (code: string) => void\n\n  constructor(options: JoystickOptions) {\n    super()\n\n    this.#onMove = options.onMove\n    this.#onRelease = options.onRelease\n    this.#onKeydown = options.onKeydown\n    this.#joystickImage = options.joystickImage\n    this.#knobImage = options.knobImage\n    this.#maxKnobDistance = options.maxKnobDistance ?? 80\n    this.#moveThreshold = options.moveThreshold ?? 0\n    this.#imageDefaultPosition = options.imageDefaultPosition ?? { left: -999999, top: -999999 }\n\n    window.addEventListener('keydown', this.#onKeyDown)\n    window.addEventListener('keyup', this.#onKeyUp)\n    window.addEventListener('blur', this.#onBlur)\n  }\n\n  protected override set renderer(renderer: Renderer | undefined) {\n    super.renderer = renderer\n    if (renderer) {\n      const c = renderer.container\n      c.addEventListener('touchstart', this.#onTouchStart)\n      c.addEventListener('touchmove', this.#onTouchMove)\n      c.addEventListener('touchend', this.#onTouchEnd)\n      c.addEventListener('touchcancel', this.#onTouchEnd)\n\n      if (this.#joystickImage) {\n        Object.assign(this.#joystickImage.style, {\n          left: `${this.#imageDefaultPosition.left}px`,\n          top: `${this.#imageDefaultPosition.top}px`,\n          zIndex: '999998',\n          transform: 'translate(-50%, -50%)',\n        })\n        c.appendChild(this.#joystickImage)\n      }\n\n      if (this.#knobImage) {\n        Object.assign(this.#knobImage.style, {\n          left: `${this.#imageDefaultPosition.left}px`,\n          top: `${this.#imageDefaultPosition.top}px`,\n          zIndex: '999998',\n          transform: 'translate(-50%, -50%)',\n        })\n        c.appendChild(this.#knobImage)\n      }\n    }\n  }\n\n  protected override get renderer() {\n    return super.renderer\n  }\n\n  #onTouchStart = (event: TouchEvent) => {\n\n  }\n\n  #onTouchMove = (event: TouchEvent) => {\n\n  }\n\n  #onTouchEnd = (event: TouchEvent) => {\n\n  }\n\n  #calculateRadianFromArrows() {\n    let dx = 0\n    let dy = 0\n\n    if (this.#arrowCodesPressed.has('ArrowUp')) dy -= 1\n    if (this.#arrowCodesPressed.has('ArrowDown')) dy += 1\n    if (this.#arrowCodesPressed.has('ArrowLeft')) dx -= 1\n    if (this.#arrowCodesPressed.has('ArrowRight')) dx += 1\n\n    if (dx !== 0 || dy !== 0) {\n      const radian = Math.atan2(dy, dx)\n      // 키보드: distance=1 로 일관 전달\n      this.#onMove(radian, 1)\n    }\n  }\n\n  #onKeyDown = (event: KeyboardEvent) => {\n\n  }\n\n  #onKeyUp = (event: KeyboardEvent) => {\n\n  }\n\n  #onBlur = () => {\n\n  }\n\n  // 조이스틱 이미지의 기본 위치(숨김 좌표) 설정\n  setImageDefaultPosition(position: { left: number; top: number }): void {\n    this.#imageDefaultPosition = position\n\n    // 드래그 중이면 즉시 반영하지 않음\n    if (this.#activeTouchId !== undefined) return\n\n    if (this.#joystickImage) Object.assign(this.#joystickImage.style, {\n      left: `${this.#imageDefaultPosition.left}px`,\n      top: `${this.#imageDefaultPosition.top}px`,\n    })\n    if (this.#knobImage) Object.assign(this.#knobImage.style, {\n      left: `${this.#imageDefaultPosition.left}px`,\n      top: `${this.#imageDefaultPosition.top}px`,\n    })\n  }\n\n  override remove() {\n    const renderer = this.renderer\n    if (renderer) {\n      const c = renderer.container\n      c.removeEventListener('touchstart', this.#onTouchStart)\n      c.removeEventListener('touchmove', this.#onTouchMove)\n      c.removeEventListener('touchend', this.#onTouchEnd)\n      c.removeEventListener('touchcancel', this.#onTouchEnd)\n    }\n    window.removeEventListener('keydown', this.#onKeyDown)\n    super.remove()\n  }\n}\n"]}