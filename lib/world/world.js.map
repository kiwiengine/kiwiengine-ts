{"version":3,"file":"world.js","sourceRoot":"","sources":["../../src/world/world.ts"],"names":[],"mappings":"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","sourcesContent":["import { GameObject, GameObjectOptions } from '../game-object/game-object';\nimport { WorldTransform } from '../game-object/transform';\nimport { debugMode } from '../utils/debug';\nimport { WorldDebug } from './world-debug';\nimport { WorldPhysics } from \"./world-physics\";\nimport { WorldRendering } from \"./world-rendering\";\n\nexport type WorldOptions = {\n  width?: number;\n  height?: number;\n  backgroundColor?: number;\n  backgroundAlpha?: number;\n  gravity?: number;\n  layers?: { name: string; drawOrder: number }[];\n} & GameObjectOptions;\n\nexport class World extends GameObject<{\n  resize: (width: number, height: number) => void;\n  collisionStart: (a: GameObject, b: GameObject) => void;\n}> {\n  container = document.createElement('div');\n  #containerResizeObserver: ResizeObserver;\n\n  _worldRendering = new WorldRendering();\n  _worldPhysics = new WorldPhysics();\n  #worldDebug = new WorldDebug(this.container);\n\n  #width?: number;\n  #height?: number;\n\n  #hasEverBeenConnected = false;\n  #destroyed = false;\n\n  #pt = new WorldTransform();\n  #update(dt: number) {\n    if (this.container.isConnected) {\n      if (!this.#hasEverBeenConnected) {\n        this.#hasEverBeenConnected = true;\n        this.#applySize();\n      }\n\n      this._worldPhysics.update(dt);\n      this._engineUpdate(dt, this.#pt);\n      this._worldRendering.update();\n      this.#worldDebug.update();\n\n      this._containerSizeDirty = false;\n    }\n\n    else if (this.#hasEverBeenConnected) {\n      this.#destroy();\n      return;\n    }\n  }\n\n  #lastContainerW = 0;\n  #lastContainerH = 0;\n  _containerSizeDirty = false;\n\n  #applySize() {\n    const rect = this.container.getBoundingClientRect();\n\n    if (rect.width === this.#lastContainerW && rect.height === this.#lastContainerH) return;\n    this.#lastContainerW = rect.width;\n    this.#lastContainerH = rect.height;\n    this._containerSizeDirty = true;\n\n    if (rect.width === 0 || rect.height === 0) return;\n\n    const canvasWidth = this.#width ?? rect.width;\n    const canvasHeight = this.#height ?? rect.height;\n\n    this._worldRendering.setRendererSize(rect, canvasWidth, canvasHeight);\n    this.#worldDebug.setMatterDebugRendererSize(rect, canvasWidth, canvasHeight, this.cameraX, this.cameraY);\n\n    this.emit('resize', this.width, this.height);\n  }\n\n  #destroy() {\n    this.#containerResizeObserver.disconnect();\n    this._worldRendering.destroy();\n    this._worldPhysics.destroy();\n    this.#worldDebug.destroy();\n\n    this.#destroyed = true;\n  }\n\n  async #init() {\n    await this._worldRendering.init(this.container, this.#width, this.#height);\n    this.#applySize();\n\n    let prevTime = 0;\n    let lagSeconds = 0;\n    let fpsCap: number | undefined;\n\n    const step = (timestamp: number) => {\n      if (this.#destroyed) return;\n\n      const dt = (timestamp - prevTime) / 1000;\n      if (dt > 0) {\n        if (fpsCap !== undefined && fpsCap > 0) {\n          lagSeconds += dt;\n          const fixedStep = 1 / fpsCap;\n          if (lagSeconds >= fixedStep) {\n            this.#update(fixedStep);\n            if (lagSeconds >= fixedStep * 2) { this.#update(dt); lagSeconds = 0; }\n            else { lagSeconds -= fixedStep; }\n          }\n        } else {\n          this.#update(dt);\n        }\n        prevTime = timestamp;\n      }\n      requestAnimationFrame(step);\n    };\n    requestAnimationFrame(step);\n\n    if (debugMode) {\n      if (!document.hasFocus()) fpsCap = 6;\n      window.addEventListener('blur', () => fpsCap = 6);\n      window.addEventListener('focus', () => fpsCap = undefined);\n      window.addEventListener('pageshow', (event) => { if (event.persisted) fpsCap = undefined; });\n    }\n  }\n\n  constructor(opts?: WorldOptions) {\n    super(opts);\n    this._setWorld(this);\n    this._worldRendering.addPixiChildToRoot(this._rendering._container);\n\n    this.#containerResizeObserver = new ResizeObserver(this.#applySize.bind(this));\n    this.#containerResizeObserver.observe(this.container);\n\n    this._worldRendering.on('positionChanged', () => this.#worldDebug.setMatterDebugRendererCamera(this.cameraX, this.cameraY));\n    this._worldPhysics.on('engineCreated', (engine) => this.#worldDebug.createMatterDebugRenderer(engine, this.width, this.height));\n    this._worldPhysics.on('collisionStart', (a, b) => this.emit('collisionStart', a, b));\n\n    if (opts) {\n      if (opts.width !== undefined) this.#width = opts.width;\n      if (opts.height !== undefined) this.#height = opts.height;\n      if (opts.backgroundColor !== undefined) this.backgroundColor = opts.backgroundColor;\n      if (opts.backgroundAlpha !== undefined) this.backgroundAlpha = opts.backgroundAlpha;\n      if (opts.gravity !== undefined) this.gravity = opts.gravity;\n\n      if (opts.layers) {\n        for (const layer of opts.layers) {\n          this._worldRendering.addLayer(layer.name, layer.drawOrder);\n        }\n      }\n    }\n\n    this.#init();\n  }\n\n  get width() { return this.#width ?? this._worldRendering.renderWidth; }\n  set width(v: number) { this.#width = v; this.#applySize(); }\n  get height() { return this.#height ?? this._worldRendering.renderHeight; }\n  set height(v: number) { this.#height = v; this.#applySize(); }\n\n  get backgroundColor() { return this._worldRendering.backgroundColor; }\n  set backgroundColor(v: number) { this._worldRendering.backgroundColor = v; }\n  get backgroundAlpha() { return this._worldRendering.backgroundAlpha; }\n  set backgroundAlpha(v: number) { this._worldRendering.backgroundAlpha = v; }\n  get gravity() { return this._worldPhysics.gravity; }\n  set gravity(v: number) { this._worldPhysics.gravity = v; }\n\n  get cameraX() { return this._worldRendering.cameraX; }\n  set cameraX(v: number) { this._worldRendering.cameraX = v; }\n  get cameraY() { return this._worldRendering.cameraY; }\n  set cameraY(v: number) { this._worldRendering.cameraY = v; }\n\n  _addToLayer(child: GameObject, layer: string) {\n    this._worldRendering.addToLayer(child, layer);\n  }\n\n  #backgroundImage?: string;\n  get backgroundImage() { return this.#backgroundImage; }\n  set backgroundImage(image: string | undefined) {\n    this.#backgroundImage = image;\n    this._worldRendering.setBackgroundImage(image);\n  }\n}\n"]}