{"version":3,"file":"audio.js","sourceRoot":"","sources":["../../src/asset/audio.ts"],"names":[],"mappings":"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","sourcesContent":["import { audioLoader } from './loaders/audio';\n\nconst audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\nwindow.addEventListener('mousedown', () => audioContext.resume());\nwindow.addEventListener('touchend', () => audioContext.resume());\n\nasync function getAvailableContext(): Promise<AudioContext> {\n  if (audioContext.state === 'suspended') await audioContext.resume();\n  return audioContext;\n}\n\nconst isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);\nlet isPageVisible = !document.hidden;\nwindow.addEventListener('visibilitychange', () => isPageVisible = !document.hidden);\n\nclass Audio {\n  src: string;\n  #volume: number;\n  #loop: boolean;\n\n  #audioBuffer?: AudioBuffer;\n  #audioContext?: AudioContext;\n  #gainNode?: GainNode;\n  #source?: AudioBufferSourceNode;\n\n  #isPlaying = false;\n  #isPaused = false;\n  #startTime = 0;\n  #pauseTime = 0;\n  #offset = 0;\n\n  constructor(src: string, volume: number, loop: boolean) {\n    this.src = src;\n    this.#volume = volume;\n    this.#loop = loop;\n    this.play();\n  }\n\n  get volume() { return this.#volume; }\n  set volume(volume: number) {\n    this.#volume = volume;\n    if (this.#gainNode) this.#gainNode.gain.value = Math.max(0, Math.min(1, volume));\n  }\n\n  async play() {\n    if (isMobile && !isPageVisible) return;\n\n    if (!this.#audioBuffer) {\n      if (!audioLoader.checkLoaded(this.src)) {\n        console.info(`Audio not preloaded. Loading now: ${this.src}`);\n      }\n      this.#audioBuffer = await audioLoader.load(this.src);\n    }\n    if (!this.#audioBuffer) return;\n\n    if (this.#isPlaying) this.stop();\n    if (!this.#isPaused) this.#offset = 0;\n    this.#isPlaying = true;\n    this.#isPaused = false;\n    if (!this.#audioContext) this.#audioContext = await getAvailableContext();\n    if (!this.#isPlaying) return;\n\n    if (!this.#gainNode) {\n      this.#gainNode = this.#audioContext.createGain();\n      this.#gainNode.gain.value = this.#volume;\n      this.#gainNode.connect(this.#audioContext.destination);\n    }\n\n    this.#source = this.#audioContext.createBufferSource();\n    this.#source.buffer = this.#audioBuffer;\n    this.#source.loop = this.#loop;\n    this.#source.connect(this.#gainNode);\n    this.#source.start(0, this.#offset);\n    this.#startTime = this.#audioContext.currentTime;\n    this.#source.onended = () => { if (!this.#isPaused && !this.#loop) this.stop(); };\n  }\n\n  #clear(): void {\n    if (this.#source) {\n      this.#source.stop();\n      this.#source.disconnect();\n      this.#source = undefined;\n    }\n  }\n\n  pause() {\n    if (this.#isPlaying && !this.#isPaused) {\n      if (this.#audioContext) {\n        this.#pauseTime = this.#audioContext.currentTime;\n        this.#offset += this.#pauseTime - this.#startTime;\n      }\n      this.#isPaused = true;\n      this.#isPlaying = false;\n      this.#clear();\n    }\n  }\n\n  stop() {\n    this.#isPlaying = false;\n    this.#isPaused = false;\n    this.#offset = 0;\n    this.#clear();\n  }\n}\n\nclass MusicPlayer {\n  #volume = 0.7;\n  #currentAudio?: Audio;\n\n  constructor() {\n    const stored = parseFloat(localStorage.getItem('musicVolume') || '');\n    this.#volume = Number.isNaN(stored) ? this.#volume : stored;\n\n    if (isMobile) {\n      document.addEventListener('visibilitychange', () => {\n        if (document.hidden) this.pause();\n        else {\n          isPageVisible = true;\n          this.#currentAudio?.play();\n        }\n      });\n    }\n  }\n\n  get volume() {\n    return this.#volume;\n  }\n\n  set volume(volume: number) {\n    this.#volume = volume;\n    localStorage.setItem('musicVolume', volume.toString());\n    if (this.#currentAudio) this.#currentAudio.volume = volume;\n  }\n\n  play(src: string) {\n    if (this.#currentAudio?.src === src) return;\n    this.#currentAudio?.stop();\n    this.#currentAudio = new Audio(src, this.#volume, true);\n  }\n\n  pause() {\n    this.#currentAudio?.pause();\n  }\n\n  stop() {\n    this.#currentAudio?.stop();\n    this.#currentAudio = undefined;\n  }\n}\n\nclass SfxPlayer {\n  #volume = 1;\n\n  constructor() {\n    const stored = parseFloat(localStorage.getItem('sfxVolume') || '');\n    this.#volume = Number.isNaN(stored) ? this.#volume : stored;\n  }\n\n  get volume() {\n    return this.#volume;\n  }\n\n  set volume(volume: number) {\n    this.#volume = volume;\n    localStorage.setItem('sfxVolume', volume.toString());\n  }\n\n  play(src: string) {\n    new Audio(src, this.#volume, false);\n  }\n}\n\nconst musicPlayer = new MusicPlayer();\nconst sfxPlayer = new SfxPlayer();\n\nexport { audioContext, musicPlayer, sfxPlayer };\n"]}